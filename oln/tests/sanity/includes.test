#! /bin/sh

# Check that each header is self contained and generates no warning.

: ${VERBOSE=1}

. ../defs || exit 1

if test "$GXX" = yes; then
  CXXFLAGS="$CXXFLAGS -Werror"
fi

set -e

rm -f failures

if test $# = 0; then
  find "$OLN_INCLUDE_DIR/oln" -name "${1-*}.hh" \
                      -a ! -path '*/old/*' \
                      -a ! -path '*/obsolete/*' -type f -print |
    sed "s,$OLN_INCLUDE_DIR/,,g"
else
  echo "$@"
fi |
while read file; do
   echo "#include <$file>" > incltest.cc
   if $CXX $CPPFLAGS $CXXFLAGS -c incltest.cc; then
      echo "  PASS: $file"
   else
      echo "  FAIL: $file"
      echo "  $file" >> failures
   fi
done

if test -f failures; then
   echo "Failed files:"
   cat failures
   rm failures
   exit 1;
fi
